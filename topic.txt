module "microsites_cluster" {
  source                   = "terraform-google-modules/kubernetes-engine/google//modules/private-cluster"
  version                  = "~> 30.0"
  project_id               = local.project_id
  name                     = "microsites-dev-cluster"
  description              = "Terraform managed microsites cluster"
  region                   = "europe-west2"
  regional                 = true
  zones                    = ["europe-west2-a", "europe-west2-b", "europe-west2-c"]
  deletion_protection      = true
  enable_shielded_nodes    = true
  enable_private_nodes     = true
  enable_private_endpoint  = true
  kubernetes_version       = "1.29.5-gke.1091000"
  release_channel          = "UNSPECIFIED"
  remove_default_node_pool = true
  fleet_project            = local.fleet_project_id
  network                  = module.vpc.network_name
  subnetwork               = google_compute_subnetwork.node_network.name
  master_ipv4_cidr_block   = "10.0.10.0/28"
  ip_range_pods            = "gke-pods"
  ip_range_services        = "gke-services"

  create_service_account = false # SA created in sy-gcp-core-iac
  service_account        = local.gke_service_account
  grant_registry_access  = true

  http_load_balancing                  = true
  network_policy                       = false
  horizontal_pod_autoscaling           = true
  filestore_csi_driver                 = false
  monitoring_enabled_components        = ["SYSTEM_COMPONENTS", "POD", "DEPLOYMENT"]
  monitoring_enable_managed_prometheus = true
  logging_enabled_components           = ["SYSTEM_COMPONENTS", "WORKLOADS"]
  gateway_api_channel                  = "CHANNEL_STANDARD"
  identity_namespace                   = "enabled"
  authenticator_security_group         = local.gke_security_group

  node_pools = [
    {
      name               = "microsites-dev-node-pool-1"
      machine_type       = "e2-standard-2"
      min_count          = 1
      max_count          = 2
      local_ssd_count    = 0
      disk_size_gb       = 30
      disk_type          = "pd-standard"
      auto_repair        = true
      auto_upgrade       = false
      autoscaling        = true
      preemptible        = true
      initial_node_count = 1
      service_account    = local.gke_service_account
      enable_secure_boot = true
    }
  ]
}
