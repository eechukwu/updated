# Provider configuration for Fleet-Account project
provider "google" {
  project = "Fleet-Account"
  region  = "europe-west2"
}

# Logging sink in Fleet-Account to receive logs from all clusters
resource "google_logging_project_sink" "fleet_sink" {
  name        = "fleet-sink"
  project     = "Fleet-Account"
  destination = "logging.googleapis.com/projects/Fleet-Account"
  filter      = "resource.type=k8s_cluster"
}

# Granting permissions for log writing to Fleet-Account
resource "google_project_iam_member" "logging_writer" {
  project = "Fleet-Account"
  role    = "roles/logging.logWriter"
  member  = "serviceAccount:service-<Fleet-Account-ID>@gcp-sa-logging.iam.gserviceaccount.com"
}

# Provider configuration for cluster-1 project
provider "google" {
  alias   = "cluster1"
  project = "cluster-1"
  region  = "europe-west2"
}

# Logging sink in cluster-1 to send logs to Fleet-Account
resource "google_logging_project_sink" "cluster_1_sink" {
  provider    = google.cluster1
  name        = "cluster-1-sink"
  project     = "cluster-1"
  destination = "logging.googleapis.com/projects/Fleet-Account"
  filter      = "resource.type=k8s_container"
}

# Granting permissions for log writing from cluster-1
resource "google_project_iam_member" "cluster_1_logging_writer" {
  provider = google.cluster1
  project  = "cluster-1"
  role     = "roles/logging.logWriter"
  member   = "serviceAccount:service-<Fleet-Account-ID>@gcp-sa-logging.iam.gserviceaccount.com"
}

# Provider configuration for cluster-2 project
provider "google" {
  alias   = "cluster2"
  project = "cluster-2"
  region  = "europe-west2"
}

# Logging sink in cluster-2 to send logs to Fleet-Account
resource "google_logging_project_sink" "cluster_2_sink" {
  provider    = google.cluster2
  name        = "cluster-2-sink"
  project     = "cluster-2"
  destination = "logging.googleapis.com/projects/Fleet-Account"
  filter      = "resource.type=k8s_container"
}

# Granting permissions for log writing from cluster-2
resource "google_project_iam_member" "cluster_2_logging_writer" {
  provider = google.cluster2
  project  = "cluster-2"
  role     = "roles/logging.logWriter"
  member   = "serviceAccount:service-<Fleet-Account-ID>@gcp-sa-logging.iam.gserviceaccount.com"
}
