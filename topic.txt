locals {
  google_artifact = {
    "wh" = {
      push_service_account = "sa-registry-wh-push",
      repositories = jsondecode(file("../common/repositories-warehouse.json"))
    },
    "rt" = {
      push_service_account = "sa-registry-rt-push",
      repositories = jsondecode(file("../common/repositories-retail.json"))
    },
    "bd" = {
      push_service_account = "sa-registry-bd-push",
      repositories = jsondecode(file("../common/repositories-buying.json"))
    },
    "ec-internal" = {
      push_service_account = "sa-registry-ec-internal-push",
      repositories = jsondecode(file("../common/repositories-ecommerce-internal.json"))
    }
  }
}

resource "google_service_account_iam_member" "sa_members" {
  for_each           = { for sa, details in local.google_artifact : sa => details.repositories }
  service_account_id = data.google_service_account.existing[each.key].id
  role               = "roles/iam.workloadIdentityUser"
  member             = format("principalSet://iam.googleapis.com/projects/%s/locations/global/workloadIdentityPools/%s/attribute.repository/frasers-group/%s", data.google_project.this.number, var.identity_pool_name, each.value)
}
