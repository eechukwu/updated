apiVersion: apps/v1
kind: Deployment
metadata:
  name: bd-inbound-source-producer-app-1
spec:
  replicas: 0
  revisionHistoryLimit: 5
  strategy: # set strategy, considering if the app can have multiple replicas or not
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate # Use Recreate here if you can only run 1 copy of your container at a time and remove the rolling update block above
  selector:
    matchLabels:
      app: prod-bd-inbound-source-producer-app-1
  template:
    metadata:
      labels: 
        app: prod-bd-inbound-source-producer-app-1
    spec:
      serviceAccountName: gcp-access
      imagePullSecrets:
        - name: prod-github-imagepull
      volumes:
        - name: gcp-secrets-volume
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: prod-gcp-secrets
        - name: appsettings-volume
          configMap:
            name: appsettings-1
            items:
              - key: appsettings.mounted-1.json
                path: appsettings.mounted.json
      containers:
      - name: bd-inbound-source-producer-app-2
        image: app # overwritten by images block in environment-specific kustomization.yaml
        imagePullPolicy: Always
        ports:
          - containerPort: 8080
            protocol: TCP
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1024Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 10
        volumeMounts:
          - name: gcp-secrets-volume
            mountPath: "/secret-volume"
            readOnly: true
          - name: appsettings-volume
            mountPath: /app/appsettings.mounted.json
            subPath: appsettings.mounted.json
        env:
          - name: ASPNETCORE_ENVIRONMENT
            value: Development
          - name: ENV_PROJECTID
            value: corp-test-mgmt-anthos-3578
          - name: ENV_CLUSTERNAME
            value: non-prod-buying
          - name: ASPNETCORE_URLS 
            value: http://*:8080
          - name: ENV_NODENAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: ENV_PODNAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: ENV_PODNAMESPACE
            value_from:
              fieldRef:
                fieldPath: metadata.namespace
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        terminationGracePeriodSeconds: 30
        imagePullSecrets:
          - name: regcred
